<html>
  <head>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      h2, h3 {
        font-weight: 400;
      }
      h2 {
        margin: 0 0 10px 0;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      header {
        background: #333;
        height: 48px;
        flex: auto;
      }
      main {
        margin: 20px;
      }
      th {
        font-weight: 100;
      }
      table {
        border-collapse: collapse;
      }
      td,
      th {
        vertical-align: top;
        border: solid #ddd 1px;
        padding: 5px;
        border-collapse: collapse;
      }
      form {
        border: solid #ddd 1px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        padding: 10px;
        position: absolute;
        top: 100px;
        left: 50%;
        width: 500px;
        margin-left: -250px;
      }
      button[type="submit"] {
        float: right;
      }
    </style>
  </head>
  <body>
    <header></header>
    <main>
      <form method="post" action="{% url 'mdv_submit_form' %}">
        <h2>Choose data for {{obj.type}}-{{obj.id}}:</h2>
        {% csrf_token %}
        <label>MDV Project name: <input name="mdv_name" value="{{obj.name}}"/></label>
        <h3>OMERO.tables</h3>
        <ul>
          {% for ann in anns %}
          <li>
            <label>
              <input name="file" type="checkbox" value="{{ann.file.id}}" />
              File ID: {{ ann.file.id }} Name: {{ann.file.name }}
            </label>
            <a target="_blank" href="{% url 'omero_table' ann.file.id %}">View Table</a>
          </li>
          {% endfor %}
        </ul>

        <label>
          <input
            id="mapAnnsCheckbox"
            name="map_anns"
            type="checkbox"
            value="{{obj.type}}-{{obj.id}}"
          />
          Map Annotations
        </label>

        <br/>
        <button type="submit">OK</button>
      </form>
      <div id="datasources">
        <!-- lit-html adds <table> here -->
      </div>
    </main>
  </body>

  <script type="module">
    let MDV_INDEX = "{% url 'mdv_index' %}";
    let obj_type = "{{obj.type}}";
    let obj_id = {{obj.id}};

    import {html, render} from 'https://unpkg.com/lit-html?module';

    // datasources is the data model - updated via AJAX when user updates form, then we render table
    let datasources = {
      // each table item is {id: {columns:[], etc} }
      omero_tables: {},
      // this object is also {columns:[], etc}
      map_anns: {columns: [], display: false}
    }


    const tableTemplate = (columns) => html`
      ${ columns.length == 0 ? "loading..." : ""}
      <table><tbody>
        <tr>${columns.map((col) => html`<th>${col.name}</th>`)}</tr>
        <tr>${columns.map((col) => html`<td>${col.values ? col.values.join(", ") : ""}</td>`)}</tr>
      </tbody></table>
    `;


    const mainTemplate = (datasources) => html`

      ${Object.values(datasources.omero_tables).map(t => t.display ? tableTemplate(t.columns) : html``)}

      ${datasources.map_anns.display ? tableTemplate(datasources.map_anns.columns) : html``}

    `;

    // Render the template to the document
    function renderTable() {
      console.log("rendering Table...", datasources);
      render(mainTemplate(datasources), document.getElementById("datasources"));
    }


    // Handle click on Tables checkbox...
    // document.getElementById("mapAnnsCheckbox").addEventListener("click", (event) => {
    function handleTableClick(event) {
      const checked = event.target.checked;
      const tableId = event.target.value;
      console.log("tableId", tableId);
      // if data not loaded...
      if (!datasources.omero_tables[tableId]) {
        datasources.omero_tables[tableId] = {columns: [], display: false}
      }
      if (checked && !datasources.omero_tables[tableId]?.columns?.length > 0) {
        let table_data = fetch(`${MDV_INDEX}table_info/${tableId}/`)
          .then(rsp => rsp.json())
          .then(data => {
            console.log("data", data);
            datasources.omero_tables[tableId].columns = data.columns;
            renderTable();
          })
      }
      datasources.omero_tables[tableId].display = checked;
      renderTable();
    };
    document.querySelectorAll("input[name='file']").forEach(i => i.addEventListener("click", handleTableClick));

  
    // Handle click on Map Annotations checkbox...
    document.getElementById("mapAnnsCheckbox").addEventListener("click", (event) => {
      const checked = event.target.checked;
      // if data not loaded...
      if (checked && datasources.map_anns.columns.length == 0) {
        let map_anns_data = fetch(`${MDV_INDEX}mapann_info/${obj_id}/`)
          .then(rsp => rsp.json())
          .then(data => {
            console.log("data", data);
            datasources.map_anns.columns = data.columns;
            renderTable();
          })
      }
      datasources.map_anns.display = checked;
      renderTable();
    });
  </script>
</html>
