import{m as $,B as y,c as m,a as S,D as k,_ as z,C as D}from"./ChartManager-c92981c9.js";class L{constructor(t,e,s={}){this.container=t,this.img=new Image,this.img.style.position="absolute",this.img.onload=i=>{this.orig_dim=[this.img.naturalWidth,this.img.naturalHeight,this.img.naturalWidth/this.img.naturalHeight],this.container.append(this.img),this.fit()},$(this.img),this.container.style.overflow="hidden",this.container.addEventListener("wheel",i=>{i.preventDefault(),this.zoom(Math.sign(i.deltaY)>0?-1:1,i)}),this.setImage(e)}setImage(t){this.img.src=t}fit(){const t=this.container.getBoundingClientRect();this.img.height=t.height,this.img.width=this.img.height*this.orig_dim[2],this.img.width>t.width?(this.img.width=t.width,this.img.height=this.img.width/this.orig_dim[2],this.img.style.top=`${(t.height-this.img.height)/2}px`,this.img.style.left="0px"):(this.img.style.top="0px",this.img.style.left=`${(t.width-this.img.width)/2}px`)}zoom(t,e){t=t>0?1.1:.9;const s=this.container.getBoundingClientRect();let i=this.img.getBoundingClientRect();const a=(e.clientX-s.left-this.img.offsetLeft)*(t-1),h=(e.clientY-s.top-this.img.offsetTop)*(t-1);this.img.width=i.width*t,this.img.height=i.height*t,this.img.style.left=`${this.img.offsetLeft-a}px`,this.img.style.top=`${this.img.offsetTop-h}px`}}class E extends y{constructor(t,e,s){if(super(t,e,s),s.image){const a=m("div",{classes:["mdv-image-holder"],style:{height:parseInt(this.width*.7)+"px"}},this.contentDiv);this.imViewer=new L(a,this._getImage(0))}this.paramHolders={};const i=m("div",{},this.contentDiv);for(let a of this.config.param){if(a===this.img_param)continue;const h=this.dataStore.columnIndex[a],o=m("div",{classes:["mdv-section"]},i);o.__mcol__=h.field,m("div",{text:h.name,classes:["mdv-section-header"]},o);let n=m("div",{classes:["mdv-section-value"]},o);h.is_url&&(n=m("a",{target:"_blank"},n)),this.paramHolders[h.field]=n}S(i,{handle:"mdv-section-header",sortEnded:a=>{const h=this.config;let o=[];h.image&&(o=[h.param[h.image.param]],h.image.param=0),h.param=o.concat(a.map(n=>n.__mcol__))}}),this.setParam(0),this.contentDiv.style.overflowY="auto"}setParam(t){for(let e in this.paramHolders){const s=this.dataStore.getRowText(t,e);this.paramHolders[e].textContent=s,this.paramHolders[e].nodeName==="A"&&(this.paramHolders[e].href=s)}}_getImage(t){const e=this.config,s=e.param[e.image.param];this.img_param=s;const i=this.dataStore.getRowText(t,s);return`${e.image.base_url}${i}.${e.image.type}`}setSize(t,e){super.setSize(t,e),this.imViewer&&(this.imViewer.container.style.height=Math.round(this.width*.7)+"px",this.imViewer.fit())}onDataHighlighted(t){const e=t.indexes[0];this.imViewer&&this.imViewer.setImage(this._getImage(e)),this.setParam(e)}onDataFiltered(){const t=this.dataStore.getFirstFilteredIndex();this.onDataHighlighted({indexes:[t]})}changeBaseDocument(t){super.changeBaseDocument(t),this.imViewer.img.__doc__=t}getSettings(){return super.getSettings()}}y.types.row_summary_box={class:E,name:"Row Summary Box",init:(l,t,e)=>{const s=e.image_set;if(s&&s!=="__none__"){const i=t.large_images[s];l.param=l.param||[],l.param.push(i.key_column),l.image={base_url:i.base_url,type:i.type,param:l.param.length-1}}},extra_controls:l=>{const t=l.large_images;if(t){let e=[];for(let s in t)e.push({name:s,value:s});return e=[{name:"none",value:"__none__"}].concat(e),[{type:"dropdown",name:"image_set",label:"Image Set",values:e}]}return[]},params:[{type:"_multi_column:all",name:"Values To Display"}]};class F{constructor(t,e,s){typeof t=="string"&&(t=document.getElementById("#"+t)),s||(s={}),this.domId=this._getRandomString(),this.row_first=0,this.row_last=139,this.tile_height=205,this.tile_width=205;let i=this;this.__doc__=document,this.display_columns=[],this.selection_mode=!0,this.imageFunc=s.imageFunc,this.base_url=s.base_url,this.parent=t,this.selected_tiles={},this.cache_size=5;const a=this.parent.getBoundingClientRect();this.config=s,s.background_color,this.view_port=m("div",{styles:{height:a.height+"px",width:a.width+"px",overflow:"auto"}},this.parent),this.canvas=m("div",{styles:{position:"relative"}},this.view_port),this.canvas.addEventListener("click",r=>{this.imageClicked(r,r.srcElement)}),this.canvas.addEventListener("mouseover",r=>{this.mouseOver(r,r.srcElement)}),this.canvas.addEventListener("keydown",r=>{this.keyPressed(r)}),this.data_view=e,this._setCanvasHeight(),this.view_port.addEventListener("scroll",r=>this._hasScrolled(r)),this.parent.append(this.view_port),this.resize_timeout=null,this.resize_timeout_length=50,this.listeners={image_clicked:new Map,image_over:new Map,image_out:new Map,data_changed:new Map,image_selected:new Map},this.highlightcolors=null,this.tag_color_palletes={},this.image_suffix=s.image_suffix?s.image_suffix:".png",s.columns&&this.setColumns(s.columns);let h=new Image;h.onload=function(r){i.originalDimensions=[h.width,h.height],i.preferred_width=i.img_width=h.width,i.preferred_height=i.img_height=h.height,s.initial_image_width&&(i.preferred_width=s.initial_image_width,i.preferred_height=Math.round(i.preferred_width/i.img_width*i.img_height)),i._resize()};const o=this.config.base_url,n=this.config.image_type,_=this.data_view.getItemField(1,this.config.image_key);h.src=`${o}${_}.${n}`}mouseOver(t,e){if(e.id){let s=e.id.split("-"),i=parseInt(s[1]),a=this.data_view.getItem(i);if(!a)return;if(this.image_over){if(a.id===this.image_over.id)return;this.listeners.image_out.forEach(h=>{h(t,this.image_over[0],self.image_over[1])})}this.listeners.image_over.forEach(h=>{h(t,a,e)}),this.image_over=e}else this.image_over&&this.listeners.image_out.forEach(s=>{s(t,self.image_over[0],self.image_over[1])}),this.image_over=null}imageClicked(t,e){let s=e.id;if(s||(s=e.parentElement.id),!s)return;let i=s.split("-");if(i[0]==="mlvtile"){let a=null,h=parseInt(i[2]);if(t.shiftKey&&self.last_img_clicked!=null){const n=this.last_img_clicked.index;range=[],a=[];let _=h-n<0?-1:1,r=n+1,c=h+1;_===-1&&(r=h,c=n);for(let p=r;p<c;p++){let d=this.data_view.getId(p);a.push(d)}a.push(this.data_view.getId(n))}const o=this.data_view.getId(h);this.listeners.image_clicked.forEach(n=>{n(t,o,e)}),this.last_index_clicked=h,this.selection_mode&&this.setSelectedTiles([h],t.ctrlKey,!0)}}keyPressed(t){if(t.which===39||t.which===40){if(this.last_index_clicked===this.data_view.getFilteredItems().length-1)return;(this.last_index_clicked||this.last_index_clicked===0)&&(this.last_index_clicked++,this.setSelectedTiles([this.data_view.getItem(this.last_index_clicked).id],!1,!0),this.last_index_clicked>this.getLastTileInView()&&this.show(this.last_index_clicked))}else if(t.which===37||t.which===38){if(this.last_index_clicked===0)return;this.last_index_clicked&&(this.last_index_clicked--,this.setSelectedTiles([this.data_view.getItem(this.last_index_clicked).id],!1,!0),this.last_index_clicked<this.getFirstTileInView()&&this.show(this.last_index_clicked))}}addListener(t,e,s){let i=this.listeners[t];return i?(s||(s=this._getRandomString()),i.set(s,e),s):null}removeListener(t,e){let s=this.listeners[t];return s?s.delete(e):!1}setImageWidth(t,e){this.setImageDimensions([t,Math.round(t/this.img_width*this.img_height)],e)}setImageLabel(t){this.config.image_label=t;const e=this.getFirstTileInView();this.setImageDimensions(),this.show(e)}setImageTitle(t){this.config.image_title=t;const e=this.getFirstTileInView();this.show(e)}setImageDimensions(t,e){this.lrm=this.config.margins.left_right,this.tbm=this.config.margins.top_bottom;let s=this.getFirstTileInView();t?(this.preferred_width=t[0],this.preferred_height=t[1]):t=[this.preferred_width,this.preferred_height],this.width<this.preferred_width+this.lrm*2&&this.width!==0?(t[0]=this.width-this.lrm*3,this.num_per_row=1):(this.num_per_row=Math.ceil((this.width-this.lrm)/(this.preferred_width+this.lrm)),t[0]=Math.floor((this.width-2*this.lrm)/this.num_per_row)-this.lrm),t[1]=Math.round(t[0]/this.preferred_width*this.preferred_height),this.config.image_label&&(this.label_size=Math.round(t[1]/12),this.label_size=Math.max(this.label_size,12),this.tbm=this.tbm<this.label_size+4?this.label_size+4:this.tbm),this.tile_width=parseInt(t[0])+this.lrm,this.tile_height=parseInt(t[1])+this.tbm,this.t_width=parseInt(t[0]),this.t_height=parseInt(t[1]);let i=Math.floor((this.height+this.cache_size*this.tile_height)/this.tile_height);this.max_difference=i+this.cache_size,e&&this.show(s)}resize(){let t=this;clearTimeout(this.resize_timeout),t.resize_timeout=setTimeout(()=>{t._resize()},t.resize_timeout_length)}getFirstTileInView(){let t=this.view_port.scrollTop;return Math.floor(t/this.tile_height)*this.num_per_row}getLastTileInView(){let t=this.view_port.scrollTop+this.view_port.height();return Math.floor(t/this.tile_height)*this.num_per_row}setColumns(t){this.columns=t}setColorBy(t,e){this.color_by=t,this.color_overlay=e}_setCanvasHeight(){let t=Math.ceil(this.data_view.getLength()/this.num_per_row)*this.tile_height+this.tbm;this.canvas.style.height=t+"px"}_hasScrolled(){clearTimeout(this.scroll_timeout);let t=this.view_port.scrollTop,e=Math.floor((t-this.cache_size*this.tile_height)/this.tile_height),s=Math.floor((t+this.height+this.cache_size*this.tile_height)/this.tile_height);e<0&&(e=0);let i=10;Math.abs(e-this.row_displayed_first)>this.max_difference&&(i=50),this.scroll_timeout=setTimeout(()=>{Math.abs(e-this.row_displayed_first)>this.max_difference?this.render(e,s,!0):this.render(e,s)},i)}_removeByClass(t){document.querySelectorAll(t).forEach(e=>e.remove())}render(t,e,s){if(s){this.canvas.innerHTML="";for(let i=t;i<e;i++)this._addRow(i)}else{if(t===this.row_displayed_first&&t!==0)return;if(t<this.row_displayed_first){for(let i=t;i<this.row_displayed_first;i++)this._addRow(i);for(let i=e;i<this.row_displayed_last;i++)this._removeByClass(`.mlv-tile-${this.domId}-${i}`)}else{for(let i=this.row_displayed_last;i<e;i++)this._addRow(i);for(let i=this.row_displayed_first;i<t;i++)this._removeByClass(`.mlv-tile-${this.domId}-${i}`)}}this.row_displayed_first=t,this.row_displayed_last=e}_resize(t){t||(t=this.getFirstTileInView());const e=this.parent.getBoundingClientRect();this.width=Math.round(e.width),this.height=Math.round(e.height),this.view_port.style.height=this.height+"px",this.view_port.style.width=this.width+"px",this.setImageDimensions(),this.show(t)}_calculateTopBottomRow(t){t||(t=0);let e=0;t||t===0?e=Math.floor(t/this.num_per_row)*this.tile_height:e=this.view_port.scrollTop;let i=this.view_port.getBoundingClientRect().height,a=Math.floor((e-this.cache_size*this.tile_height)/this.tile_height),h=Math.floor((e+i+this.cache_size*this.tile_height)/this.tile_height);return a<0&&(a=0),{top:a,bottom:h,scroll_top:e}}setSelectedTiles(t,e,s){if(!e){for(let i in this.selected_tiles){let a=this.__doc__.getElementById(`mlvtile-${this.domId}-${i}`);a&&(a.style.border=this.selected_tiles[i])}this.selected_tiles={}}for(let i of t){let a=this.__doc__.getElementById(`mlvtile-${this.domId}-${i}`);a&&(this.selected_tiles[i]=a.style.border,a.style.border="4px solid goldenrod",console.log(a.style.border))}s&&this.listeners.image_selected.forEach(i=>{i(t)})}scrollToTile(t,e){const s=this.data_view.data.indexOf(t);let i=this._calculateTopBottomRow(s);Math.abs(i.top-this.row_displayed_first)>this.max_difference?this.render(i.top,i.bottom,!0):this.render(i.top,i.bottom),this.view_port.scrollTop=i.scroll_top,e&&this.setSelectedTiles([s])}_getRandomString(t,e){t||(t=6),e=e&&e.toLowerCase();let s="",i=0,a=e=="a"?10:0,h=e=="n"?10:62;for(;i++<t;){let o=Math.random()*(h-a)+a<<0;s+=String.fromCharCode(o+=o>9?o<36?55:61:48)}return s}show(t){t||(t=this.getFirstTileInView()),this._setCanvasHeight();let e=this._calculateTopBottomRow(t);this.render(e.top,e.bottom,!0),this.view_port.scrollTop=e.scroll_top}_addRow(t){const e=this.config.image_label;let s=t*this.num_per_row,i=s+this.num_per_row,a=t*this.tile_height+this.tbm,h=0;const o=this.t_width+"px",n=this.t_height+"px",_=this.config.base_url,r=this.config.image_type,c=this.config.image_title||"Gene",p=this.data_view.dataStore.columnIndex[c]!==void 0;for(let d=s;d<i;d++){const f=this.data_view.getId(d);if(f==null)return;const g=this.data_view.getItemField(d,this.config.image_key),T=p?`${c} '${this.data_view.getItemField(d,c)}'`:g,M=g==="missing";let v=h*this.tile_width+this.lrm;h++;let b="";if(this.color_by){let C=this.color_by(f);b="4px solid "+C,this.color_overlay&&m("div",{styles:{height:n,width:o,left:v+"px",top:a+"px",zIndex:1,pointerEvents:"none",backgroundColor:C,opacity:this.color_overlay},classes:["mlv-tile",`mlv-tile-overlay-${this.domId}`,`mlv-tile-overlay-${this.domId}-${t}`]},this.canvas)}let B=[];this.selected_tiles[f]&&(b="4px solid goldenrod"),M&&B.push("mlv-tile-missing"),m("img",{src:`${_}${g}.${r}`,id:`mlvtile-${this.domId}-${d}`,styles:{border:b,height:n,width:o,left:v+"px",top:a+"px"},alt:T,title:T,classes:["mlv-tile",`mlv-tile-${this.domId}`,`mlv-tile-${this.domId}-${t}`].concat(B)},this.canvas),e&&m("div",{text:this.data_view.getItemField(d,e),classes:["mdv-image-label"],styles:{width:o,fontSize:`${this.label_size}px`,top:a-this.label_size+"px",left:v+"px"}},this.canvas)}}}class R extends y{constructor(t,e,s){super(t,e,s),this.dataModel=new k(t,{autoupdate:!1}),this.dataModel.setColumns(this.config.param),this.dataModel.updateModel();const i=this.config;i.margins=i.margins||{top_bottom:10,left_right:10},this.grid=new F(this.contentDiv,this.dataModel,{base_url:i.images.base_url,image_type:i.images.type,image_key:i.param[0],initial_image_width:i.image_width,image_label:i.image_label,margins:i.margins}),this.grid.addListener("image_clicked",(a,h)=>{this.dataStore.dataHighlighted([h],this)},i.id),i.sortBy&&this.sortBy(i.sortBy,i.sortOrder)}setSize(t,e){super.setSize(t,e),this.grid.resize()}onDataFiltered(){this.dataModel.updateModel(),this.grid.show()}getColorOptions(){return{colorby:"all",color_overlay:0}}onDataHighlighted(t){if(t.source===this)return;const e=t.indexes[0];this.grid.scrollToTile(e,!0)}setImageLabel(t){this.config.image_label=t,this.grid.setImageLabel(t)}colorByColumn(t){this.grid.setColorBy(this.getColorFunction(t,!1),this.config.color_overlay);const e=this.grid.getFirstTileInView();this.grid.show(e)}colorByDefault(){this.grid.setColorBy(null);const t=this.grid.getFirstTileInView();this.grid.show(t)}sortBy(t,e=!0){this.config.sortBy=t,this.config.sortOrder=e,this.dataModel.sort(t,e?"asc":"desc");const s=this.grid.getFirstTileInView();this.grid.show(s)}setImageTitle(t){this.config.image_title=t,this.grid.setImageTitle(t)}getSettings(){const t=this.grid.originalDimensions,e=this.config,s=super.getSettings(),i=this.dataStore.getColumnList("all",!0);return s.concat([{type:"slider",max:t[1]*4,min:10,doc:this.__doc__,label:"Image Size",current_value:e.image_width||t[0],func:a=>{e.image_width=a,this.grid.setImageWidth(a,!0)}},{label:"Label",type:"dropdown",values:[i,"name","field"],current_value:e.image_label||"__none__",func:a=>{this.setImageLabel(a==="__none__"?null:a)}},{label:"Tooltip",type:"dropdown",values:[i,"name","field"],current_value:e.image_title||"__none__",func:a=>{this.setImageTitle(a==="__none__"?void 0:a)}},{label:"Sort By",type:"dropdown",values:[i,"name","field"],current_value:e.sortBy||"__none__",func:a=>{this.sortBy(a==="__none__"?null:a)}},{label:"Sort Ascending?",type:"check",current_value:e.sortOrder||!0,func:a=>{this.sortBy(e.sortBy,a)}}])}changeBaseDocument(t){super.changeBaseDocument(t),this.grid.__doc__=t}}y.types.image_table_chart={class:R,name:"Image Table",required:["images"],methodsUsingColumns:["setImageLabel","sortBy","setTitleColumn"],configEntriesUsingColumns:["image_label","sort_by","image_title"],init:(l,t,e)=>{const s=t.images[e.image_set];l.param=[s.key_column],l.images={base_url:s.base_url,type:s.type},l.sortBy=e.sort_by,l.sortOrder=e.sort_order},extra_controls:l=>{const t=[];for(let s in l.images)t.push({name:s,value:s});const e=l.getLoadedColumns().map(s=>({name:s,value:s}));return[{type:"dropdown",name:"image_set",label:"Image Set",values:t},{type:"dropdown",name:"image_title",label:"Tooltip",values:e},{type:"dropdown",name:"sort_by",label:"Sort By",values:e}]}};function V(l,t){const e={};for(let s of l)e[s.name]=new H(`${t}/${s.name}.b`,s.size);return async(s,i,a)=>await e[i].getColumnData(s,a)}class H{constructor(t,e){this.url=t,this.index=null,this.size=e}async getColumnData(t,e){const{default:s}=await z(()=>import("./pako.esm-0a50cf5c.js"),[],import.meta.url);if(!this.index){const i=this.url.replace(".b",".json"),a=await fetch(i);this.index=await a.json()}return await Promise.all(t.map(async i=>{let a=i.field;if(i.subgroup){const r=i.field.split("|");a=r[0]+r[2]}const h=this.index[a],n=await(await fetch(this.url,{headers:{responseType:"arraybuffer",range:`bytes=${h[0]}-${h[1]}`}})).arrayBuffer(),_=s.inflate(n);if(i.sgtype==="sparse"){const r=new Uint32Array(_,0,1)[0],c=new Uint32Array(_,4,r),p=new Float32Array(_,r*4+1,r),d=new SharedArrayBuffer(e*4),f=new Float32Array(d);f.fill(NaN);for(let g=0;g<c.length;g++)f[c[g]]=p[g];return{data:d,field:i.field}}else{const r=new SharedArrayBuffer(_.length);return new Uint8Array(r).set(_,0),{data:r,field:i.field}}}))}}document.addEventListener("DOMContentLoaded",()=>P());const A=new URLSearchParams(window.location.search),w=A.get("dir")||prompt("Enter data URL","https://mdvstatic.netlify.app/ytrap2"),u=w.endsWith("/")?w.substring(0,w.length-1):w;document.title=`MDV - ${u}`;function x(l){if(Array.isArray(l)){for(const t of l)x(t);return}for(const t in l)t==="base_url"?l[t]=l[t].replace("./",`${u}/`):typeof l[t]=="object"&&x(l[t])}async function I(l){const e=await(await fetch(l)).json();return x(e),e}async function P(){const l=await I(`${u}/datasources.json`),t=await I(`${u}/state.json`),e=await I(`${u}/views.json`),s={function:V(l,u),viewLoader:async i=>e[i]};new D("app1",l,s,t)}
